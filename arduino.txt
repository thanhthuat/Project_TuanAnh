#include <TimerOne.h>
#define x1 2
#define v1 3
#define d1 4
#define x2 5
#define v2 6
#define d2 7
#define sw 9
#define sh 13
#define ds 12
#define st 11
const int Seg[10] = {
  0b11000000,//0
  0b11111001,//1
  0b10100100,//2
  0b10110000,//3
  0b10011001,//4
  0b10010010,//5
  0b10000010,//6
  0b11111000,//7
  0b10000000,//8
  0b10010000,//9
};
volatile boolean clk_1hz =0; //bien thay doi 1 cach k bao truoc volatile
volatile boolean clk_1hz1 =0; //bien thay doi 1 cach k bao truoc volatile
volatile unsigned int count0 = 0;//bien thay doi 1 cach k bao truoc volatile
volatile unsigned int count = 0;//bien thay doi 1 cach k bao truoc volatile
volatile unsigned int count1= 0;//bien thay doi 1 cach k bao truoc volatile
unsigned int led1=10;
unsigned int led2=10;
unsigned int led3=10;
unsigned int led4=10;
unsigned int dem=0;



void setup()
{
  for (int i=11; i<14;i++){
  pinMode(i, OUTPUT);}
  for (int i=2; i<8 ;i++){
  pinMode(i, OUTPUT);}
  pinMode(9,INPUT_PULLUP);
  Timer1.initialize(500000);//khởi tạo timer 1 đến 0.5 giâ
  Timer1.attachInterrupt(ngattimer);
 // Timer1.attachInterrupt(ngattimer1);
  Serial.begin(9600); //Set Baudrate của Serial
  //chay chuong trinh sau moi 0.5s
 
 
  }
 void ngattimer()
 {clk_1hz= !clk_1hz;
  count0= (clk_1hz?(count0<30?count0+1:0):count0);
  count1= (clk_1hz?(count1<56?count1+1:0):count1);
  // clk_1hz =0 thi count = count ve sau
  //tao bien count  1s
  //luon dem
  }
 
  
void loop()
{
  boolean bit_sw = digitalRead(sw);
   count0=count0;
   count1=count1;
   if(Serial.available() > 0) //Nếu có tín hiệu gửi đến Serial
  {
    char ledState = Serial.read(); //Đọc giá trị gửi
    if(ledState == '1') //Nếu gửi '1'
    {
     dem=0;
     count0=0;
    }else if(ledState == '0') //Nếu gửi '0'
    {
      dem=1;
      count1=0;
      
      
    }else if(ledState == '2'){
      dem=2;
      count=10;
    }
  }
     if(dem==0){
      count=count0;
    Serial.println("count 0:");
    Serial.println(count);
    
  digitalWrite(x1,!bit_sw && count<=10);
  digitalWrite(v1,!bit_sw && count>10 &&count<=15 ||bit_sw && clk_1hz);
  digitalWrite(d1,!bit_sw && count>15);
  digitalWrite(d2,!bit_sw &&count<=15);
  digitalWrite(x2,!bit_sw && count>15 && count<=25);
  digitalWrite(v2,!bit_sw &&count>25|| bit_sw &&clk_1hz);
  //hien thi led 7 doan
  led1=(bit_sw?10:(count<=10?(10-count)%10:(count<=15?(15-count)%10:(30-count)%10)));
  //don vi 
  led2=(bit_sw?10:(count<=10?(10-count)/10:(count<=15?(15-count)/10:(30-count)/10)));
  //chuc
  led3=(bit_sw?10:(count<=15?(15-count)%10:(count<=25?(25-count)%10:(30-count)%10)));
  //don vi
  led4=(bit_sw?10:(count<=15?(15-count)/10:(count<=25?(25-count)/10:(30-count)/10)));
  //chuc
  digitalWrite(st,0);
  shiftOut(ds, sh, MSBFIRST, Seg[led1]);
  //shiftOut(dataPin, clockPin, bitOrder, value) 
  shiftOut(ds, sh, MSBFIRST, Seg[led2]);
  shiftOut(ds, sh, MSBFIRST, Seg[led3]);
  shiftOut(ds, sh, MSBFIRST, Seg[led4]);
  digitalWrite(st,1);
  }else if(dem==1){
    count=count1;
    Serial.println("count 1:");
    Serial.println(count1);
    
  digitalWrite(x1,!bit_sw && count<=25);
  digitalWrite(v1,!bit_sw && count>25 &&count<=28 ||bit_sw && clk_1hz);
  digitalWrite(d1,!bit_sw && count>28);
  digitalWrite(d2,!bit_sw &&count<=28);
  digitalWrite(x2,!bit_sw && count>28 && count<=53);
  digitalWrite(v2,!bit_sw &&count>53|| bit_sw &&clk_1hz);
  //hien thi led 7 doan
  led1=(bit_sw?10:(count<=25?(25-count)%10:(count<=28?(28-count)%10:(56-count)%10)));
  //don vi 
  led2=(bit_sw?10:(count<=25?(25-count)/10:(count<=28?(28-count)/10:(56-count)/10)));
  //chuc
  led3=(bit_sw?10:(count<=28?(28-count)%10:(count<=53?(53-count)%10:(56-count)%10)));
  //don vi
  led4=(bit_sw?10:(count<=28?(28-count)/10:(count<=53?(53-count)/10:(56-count)/10)));
  //chuc
  digitalWrite(st,0);
  shiftOut(ds, sh, MSBFIRST, Seg[led1]);
  //shiftOut(dataPin, clockPin, bitOrder, value) 
  shiftOut(ds, sh, MSBFIRST, Seg[led2]);
  shiftOut(ds, sh, MSBFIRST, Seg[led3]);
  shiftOut(ds, sh, MSBFIRST, Seg[led4]);
  digitalWrite(st,1);
  }else if(dem==2){
    Serial.println("count 2:");
     Serial.println(count1);
  }
   
  
  delay(1000);

 
//  count=(bit_sw?1:count);
  // nhan se chay mau vang,bien count =0;
 /*
  
  //!, &&, ||
  digitalWrite(x1,!bit_sw && count<=10);
  digitalWrite(v1,!bit_sw && count>10 &&count<=15 ||bit_sw && clk_1hz);
  digitalWrite(d1,!bit_sw && count>15);
  digitalWrite(d2,!bit_sw &&count<=15);
  digitalWrite(x2,!bit_sw && count>15 && count<=25);
  digitalWrite(v2,!bit_sw &&count>25|| bit_sw &&clk_1hz);
  //hien thi led 7 doan
  led1=(bit_sw?10:(count<=10?(10-count)%10:(count<=15?(15-count)%10:(30-count)%10)));
  //don vi 
  led2=(bit_sw?10:(count<=10?(10-count)/10:(count<=15?(15-count)/10:(30-count)/10)));
  //chuc
  led3=(bit_sw?10:(count<=15?(15-count)%10:(count<=25?(25-count)%10:(30-count)%10)));
  //don vi
  led4=(bit_sw?10:(count<=15?(15-count)/10:(count<=25?(25-count)/10:(30-count)/10)));
  //chuc
  digitalWrite(st,0);
  shiftOut(ds, sh, MSBFIRST, Seg[led1]);
  //shiftOut(dataPin, clockPin, bitOrder, value) 
  shiftOut(ds, sh, MSBFIRST, Seg[led2]);
  shiftOut(ds, sh, MSBFIRST, Seg[led3]);
  shiftOut(ds, sh, MSBFIRST, Seg[led4]);
  digitalWrite(st,1);
  */
 
  
  }